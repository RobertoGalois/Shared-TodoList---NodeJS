<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Todo list partagée</title>
        <style>
            a{
                text-decoration: none;
                color: black;
            }
        </style>
    </head>
    <body>
        <section>
            <h1>Todo list partagée </h1>
            <ul id="todoList">
            </ul>
            <form>
                <label for="texteTache">Que dois-je faire ?</label>
                <input type="text" id="texteTache" name="texteTache" />
                <input type="submit" value="Valider" />
            </form>
        </section>
    </body>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        // récupération des éléments d'interface pour mise à jour
        let todoListElt = document.getElementById("todoList");
        // connexion au socket
        let socket = io.connect('http://localhost:8080');
        // on récupère la liste complète des tâches
        socket.on('touteLaListe', liste => {
            todoListElt.innerHTML = "";
            for (i=0;i<liste.length;i++){
                let tacheHTML = `<li><a href="" class="lienX" id="${i}">✘</a> ${liste[i]}</li>`
                todoListElt.insertAdjacentHTML('beforeend',tacheHTML);
                // on ajoute un listener pour le clic de suppression
                let lienSuppr = document.getElementById(i);
                lienSuppr.addEventListener("click",supprimerTache);
            }
        });
        // on écoute le submit du formulaire pour savoir quand ajouter une tâche
        let formElt = document.querySelector('form');
        formElt.addEventListener('submit', e=>{
            // On désactive le comportement par défaut du formulaire
            e.preventDefault();
            // on envoie la nouvelle tache au serveur
            let tacheAAjouter = e.target.elements.texteTache.value
            if (tacheAAjouter !== ''){
                socket.emit('nouvelle_tache',tacheAAjouter);
                e.target.elements.texteTache.value = "";
            }
        });
        // on écoute l'ajout des tâches
        socket.on('nouvelle_tache',tache=>{
            let tacheHTML = `<li><a href="#" class="lienX" id="${tache.id}">✘</a> ${tache.tache}</li>`
            todoListElt.insertAdjacentHTML('beforeend',tacheHTML);
            // on ajoute un listener pour le clic de suppression
            let lienSuppr = document.getElementById(tache.id);
            lienSuppr.addEventListener("click",supprimerTache);
        });
        // on écoute chaque lien "X" de la todo list pour envoyer l'ordre de suppression au serveur si c'est cliqué
        let liensXElts = document.getElementsByClassName("lienX");
        // fonction de suppression de tache
        function supprimerTache(e){
            // récupération de l'id du lien
            let id = e.target.id;
            // on désactive le comportement par défaut du lien
            e.preventDefault();
            e.target.removeEventListener("click",supprimerTache);
            socket.emit('supprimer_tache', id);
        }
    </script>
</html>